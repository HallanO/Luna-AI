// LunaFace.cpp - Implementation
#include "LunaFace.h"

// Define the static bitmap data here in the .cpp file
const unsigned char LunaFace::_micBitmap[] PROGMEM = {
  // 64x64 microphone icon bitmap (8 bytes per row = 64 bits)
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x3F, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xFC, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x7F, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0xFE, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x7F, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 
  0x00, 0x0F, 0xE0, 0xFF, 0xFF, 0x07, 0xF0, 0x00, 0x00, 0x0F, 0xE0, 0xFF, 0xFF, 0x07, 0xF0, 0x00, 
  0x00, 0x0F, 0xE0, 0x7F, 0xFE, 0x07, 0xF0, 0x00, 0x00, 0x0F, 0xE0, 0x7F, 0xFE, 0x07, 0xF0, 0x00, 
  0x00, 0x07, 0xE0, 0x7F, 0xFE, 0x07, 0xE0, 0x00, 0x00, 0x07, 0xE0, 0x7F, 0xFE, 0x07, 0xE0, 0x00, 
  0x00, 0x07, 0xF0, 0x3F, 0xFC, 0x0F, 0xE0, 0x00, 0x00, 0x07, 0xF0, 0x1F, 0xF8, 0x0F, 0xE0, 0x00, 
  0x00, 0x03, 0xF8, 0x07, 0xE0, 0x1F, 0xC0, 0x00, 0x00, 0x03, 0xFC, 0x00, 0x00, 0x3F, 0xC0, 0x00, 
  0x00, 0x01, 0xFE, 0x00, 0x00, 0x7F, 0x80, 0x00, 0x00, 0x01, 0xFF, 0x00, 0x00, 0xFF, 0x80, 0x00, 
  0x00, 0x00, 0x7F, 0xC0, 0x03, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xF0, 0x0F, 0xFC, 0x00, 0x00, 
  0x00, 0x00, 0x1F, 0xFF, 0xFF, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 
  0x00, 0x00, 0x07, 0xFF, 0xFF, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xFF, 0xFF, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x3F, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x07, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Constructor
LunaFace::LunaFace(Adafruit_ST7789* tft) {
  _tft = tft;
  _currentState = FACE_IDLE;
  _lastBlink = 0;
  _lastTilt = 0;
  _nextBlinkDelay = random(3000, 5000);
  _nextTiltDelay = random(5000, 8000);
}

// Initialize colors and display
void LunaFace::begin() {
  _pink = _tft->color565(255, 180, 200);
  _blush = _tft->color565(255, 130, 160);
  _micColor = _tft->color565(100, 100, 255);
  _dotColor = _tft->color565(100, 100, 255);
  
  clearScreen();
  showIdle();
}

// Clear screen with pink background
void LunaFace::clearScreen() {
  _tft->fillScreen(_pink);
}

// Draw eyes (open or closed)
void LunaFace::drawEyes(int16_t cx, bool closed) {
  int16_t leftX = cx - EYE_OFFSET_X;
  int16_t rightX = cx + EYE_OFFSET_X;
  
  if (closed) {
    // Draw closed eyes (horizontal lines)
    _tft->fillCircle(leftX, EYE_Y, EYE_RADIUS, _pink);
    _tft->fillCircle(rightX, EYE_Y, EYE_RADIUS, _pink);
    _tft->fillRect(leftX - 25, EYE_Y - 3, 50, 6, 0x0000);
    _tft->fillRect(rightX - 25, EYE_Y - 3, 50, 6, 0x0000);
  } else {
    // Draw open eyes with highlights
    _tft->fillCircle(leftX, EYE_Y, EYE_RADIUS, 0x0000);
    _tft->fillCircle(rightX, EYE_Y, EYE_RADIUS, 0x0000);
    _tft->fillCircle(leftX - 10, EYE_Y - 10, 10, 0xFFFF);
    _tft->fillCircle(rightX - 10, EYE_Y - 10, 10, 0xFFFF);
    _tft->fillCircle(leftX + 8, EYE_Y + 8, 6, 0xFFFF);
    _tft->fillCircle(rightX + 8, EYE_Y + 8, 6, 0xFFFF);
  }
}

// Draw blush cheeks
void LunaFace::drawBlush(int16_t cx) {
  int16_t leftX = cx - EYE_OFFSET_X;
  int16_t rightX = cx + EYE_OFFSET_X;
  int16_t blushW = 20;
  int16_t blushH = 12;
  int16_t blushRadius = 5;
  
  _tft->fillRoundRect(leftX - 10 - blushW/2, BLUSH_Y - blushH/2, 
                      blushW, blushH, blushRadius, _blush);
  _tft->fillRoundRect(rightX + 10 - blushW/2, BLUSH_Y - blushH/2, 
                      blushW, blushH, blushRadius, _blush);
}

// Draw smile mouth
void LunaFace::drawSmileMouth(int16_t cx) {
  int smileWidth = 44;
  int smileHeight = 15;
  
  for (int t = 0; t < 8; t++) {
    for (int angle = 0; angle <= 180; angle += 2) {
      float rad = angle * 3.14159 / 180.0;
      int x = cx + ((smileWidth/2) - t) * cos(rad);
      int y = MOUTH_Y + (smileHeight - t) * sin(rad);
      _tft->drawPixel(x, y, 0x0000);
    }
  }
}

// Draw oval mouth (for talking)
void LunaFace::drawOvalMouth(int16_t cx, int width, int height) {
  _tft->fillRoundRect(cx - width/2, MOUTH_Y - height/2, 
                      width, height, 10, 0x0000);
}

// Draw circle mouth (for listening/thinking)
void LunaFace::drawCircleMouth(int16_t cx, int radius) {
  _tft->fillCircle(cx, MOUTH_Y, radius, 0x0000);
}

// Clear mouth area
void LunaFace::clearMouthArea(int16_t cx) {
  _tft->fillRect(cx - 40, MOUTH_Y - 25, 80, 50, _pink);
}

// Show idle face (normal cute face)
void LunaFace::showIdle() {
  clearScreen();
  drawEyes(CENTER_X, false);
  drawBlush(CENTER_X);
  drawSmileMouth(CENTER_X);
  _currentState = FACE_IDLE;
}

// Show listening face (Luna looks left, mic on right)
void LunaFace::showListening() {
  clearScreen();
  
  int16_t cx = CENTER_X - 30;  // Shift left
  drawEyes(cx, false);
  drawBlush(cx);
  drawCircleMouth(cx, 15);
  
  // Draw microphone
  int micX = DISPLAY_WIDTH - BITMAP_WIDTH - 10;
  int micY = (DISPLAY_HEIGHT - BITMAP_HEIGHT) / 2;
  _tft->drawBitmap(micX, micY, _micBitmap, BITMAP_WIDTH, BITMAP_HEIGHT, _micColor);
  
  _currentState = FACE_LISTENING;
}

// Show thinking face with spinner animation
void LunaFace::showThinking() {
  clearScreen();
  drawEyes(CENTER_X, false);
  drawBlush(CENTER_X);
  drawCircleMouth(CENTER_X, 15);
  
  _currentState = FACE_THINKING;
  
  // Thinking spinner animation (3 seconds)
  int16_t centerX = DISPLAY_WIDTH - 50;
  int16_t centerY = 40;
  int totalFrames = 60;
  float angleStep = 360.0 / DOT_COUNT;
  
  for (int frame = 0; frame < totalFrames; frame++) {
    _tft->fillCircle(centerX, centerY, ORBIT_RADIUS + DOT_RADIUS + 2, _pink);
    
    float rotationAngle = frame * 6.0;
    for (int i = 0; i < DOT_COUNT; i++) {
      float angle = (rotationAngle + (i * angleStep)) * 3.14159 / 180.0;
      int dotX = centerX + ORBIT_RADIUS * cos(angle);
      int dotY = centerY + ORBIT_RADIUS * sin(angle);
      _tft->fillCircle(dotX, dotY, DOT_RADIUS, _dotColor);
    }
    delay(50);
  }
  
  // Clear spinner
  _tft->fillCircle(centerX, centerY, ORBIT_RADIUS + DOT_RADIUS + 2, _pink);
}

// Show talking animation
void LunaFace::showTalking(int duration) {
  clearScreen();
  drawEyes(CENTER_X, false);
  drawBlush(CENTER_X);
  
  _currentState = FACE_TALKING;
  
  int iterations = duration / 100;
  for (int i = 0; i < iterations; i++) {
    clearMouthArea(CENTER_X);
    int width = 36;
    int height = random(8, 28);
    drawOvalMouth(CENTER_X, width, height);
    delay(100);
  }
  
  // Return to smile
  clearMouthArea(CENTER_X);
  drawSmileMouth(CENTER_X);
}

// Blink animation
void LunaFace::blink() {
  if (_currentState != FACE_IDLE) return;
  
  drawEyes(CENTER_X, true);
  delay(100);
  drawEyes(CENTER_X, false);
}

// Head tilt animation
void LunaFace::tilt() {
  if (_currentState != FACE_IDLE) return;
  
  int direction = random(0, 2) ? 1 : -1;
  int tiltAmount = 12;
  int16_t cx = CENTER_X + (tiltAmount * direction);
  
  clearScreen();
  drawEyes(cx, false);
  drawBlush(cx);
  drawSmileMouth(cx);
  
  delay(1000);
  showIdle();
}

// Update - call in loop() for automatic animations
void LunaFace::update() {
  if (_currentState != FACE_IDLE) return;
  
  unsigned long now = millis();
  
  // Blink
  if (now - _lastBlink >= _nextBlinkDelay) {
    blink();
    _lastBlink = now;
    _nextBlinkDelay = random(3000, 5000);
  }
  
  // Tilt
  if (now - _lastTilt >= _nextTiltDelay) {
    tilt();
    _lastTilt = now;
    _nextTiltDelay = random(5000, 8000);
  }
}